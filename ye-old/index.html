<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <!--<meta name="viewport" content="width=device-width, initial-scale=1.0">-->

  <title>CRN Polyglot - A ComET Project</title>

  <link rel="stylesheet" href="css/foundation.min.css">
  <link rel="stylesheet" href="fonts/foundation-icons/foundation-icons.css">
  <link rel="stylesheet" href="css/style.css">
</head>

<body>
  <div class="sticky">
    <nav class="top-bar" data-topbar role="navigation" data-options="sticky_on: large">
      <ul class="title-area">
        <li class="name">
          <h1><a href="#" v-on:click="backToInput()">CRN Polyglot</a></h1>
        </li>
        <li class="toggle-topbar menu-icon"><a href="#"><span>Menu</span></a></li>
      </ul>
      <section class="top-bar-section">
        <ul class="left">
          <li class="has-dropdown">
            <a href="#"><i class="fi-page"></i> File</a>
            <ul class="dropdown">
              <li><a href="#" onclick="loadCRNP();">Open CRN File</a></li>
              <li><a href="#" onclick="saveCRNP();">Save CRN File</a></li>
              <!--<li><a href="#" v-on:click="generate()">Generate CRN File</a></li>-->
            </ul>
          </li>
          <li><a href="#" v-on:click="generate()">Generate CRN File</a></li>
          <!--<li><a href="analyse_crn.html"><i class="fi-eye"></i> Analyse CRN</a></li>
          <li><a href="#"><i class="fi-info"></i> Help</a></li>-->
        </ul>
      </section>
    </nav>
  </div>

  <div id="independent-reactions-modal" class="reveal-modal" data-reveal aria-labelledby="modalTitle" aria-hidden="true" role="dialog">
    <h2 id="modalTitle">Add Independent Reactions</h2>
    <div class="row">
      <div class="small-6 columns">
        <label>
          Variable
          <input type="text" id="var" v-model="independentReactionModal.variable">
        </label>
      </div>
      <div class="small-3 columns">
        <label>
          Start Index
          <input type="number" id="start-i" v-model="independentReactionModal.startIndex">
        </label>
      </div>
      <div class="small-3 columns">
        <label>
          End Index
          <input type="number" id="end-i" v-model="independentReactionModal.endIndex">
        </label>
      </div>
    </div>
    <div class="row">
      <a href="#" class="primary button right" v-on:click="addIndependentReactions()">Add</a>
    </div>
    <a class="close-reveal-modal" aria-label="Close">×</a>
  </div>

  <div class="main-content">
    <div v-show="!viewOutput">
      <div class="row">
        
        <div class="small-4 columns">
          <input class="text-field" type="text" size="30" placeholder="Model name" id="model_name" v-model="modelName">
        </div>
        <div class="small-6 columns">
          <a class="clear-button my-button" href="#" id="clear-reaction" v-on:click="clearReactions()"><i class="fi-trash"></i> Clear All Reactions</a>
          <a class="indep-button my-button" href="#" data-reveal-id="independent-reactions-modal"><i class="fi-plus"></i> Add Independent Reactions</a>
        </div>
      </div>
      
      <div class="row">
  
        <table id="chemical-reaction-table">
          <thead>
            <tr>
              <th colspan="2">REACTANT</th>
              <th></th>
              <th colspan="2">PRODUCT</th>
            </tr>
          </thead>
          <tbody>
            <tr v-for="reaction in reactions">
              <td class="vertical-align">
                <h5>{{ $index + 1 }}</h5></td>
              <td class="center-vertically">
                <input class="text-field" type="text" size="30" placeholder="Ø" id="reactant-{{ $index }}" v-model="reaction.reactant" v-on:keyup.enter="nextReaction($index)"
                v-on:input="saveReactions()">
              </td>
              <td class="center-vertically">
                <select class="my-dropdown" v-model="reaction.arrow" v-on:input="saveReactions()">
                  <option value="->">→</option>
                  <option value="<->">↔</option>
                  <option value="<-">←</option>
                </select>
              </td>
              <td class="center-vertically">
                <input class="text-field product-field" type="text" size="30" placeholder="Ø" id="product-{{ $index }}" v-model="reaction.product"
                v-on:keyup.enter="nextReaction($index)" v-on:input="saveReactions()">
              </td>
              <td><a class="delete-button my-button delete-row" href="#" v-on:click="removeReaction($index)"><i class="fi-x"></i></a></td>
            </tr>
          </tbody>
        </table>
  
        <p class="text-center">To add another reaction, simply press enter on any of the text fields</p>
      </div>
    </div>
    
    <div class="row" v-show="viewOutput">
      <h2>ERNEST</h2>
      <p>Copy and paste the code below to a .m file and run it on MATLAB.</p>
      <pre><code style="display: block; overflow: auto;">{{output.ernest}}</code></pre>
      <h2>CoNtRol</h2>
      <p>Copy and paste the code below to a .txt file and upload it to CoNtRol (left sidebar).</p>
      <pre><code style="display: block; overflow: auto;">{{output.control}}</code></pre>
      <h2>CRN Toolbox</h2>
      <p>Copy and paste the code below to a .NET file and open it with CRN Toolbox.</p>
      <pre><code style="display: block; overflow: auto;">{{output.crntoolbox}}</code></pre>
    </div>
  </div>

  <script src="js/vendor/modernizr.js"></script>
  <script src="js/vendor/jquery.js"></script>
  <script src="js/foundation.min.js"></script>
  <script src="js/vue.js"></script>
  <script>
    $(document).foundation();
  </script>

  <script>
    function blankReaction() {
      return { reactant: '', product: '', arrow: '->' };
    }
    
    var vm = new Vue({
      el: 'body',
      data: { 
        viewOutput: false,
        modelName: loadModelName() || '',
        reactions: loadReactions() || [blankReaction()],
        independentReactionModal: {
          variable: 'X',
          startIndex: 1,
          endIndex: 1,
        },
        output: {
          ernest: '',
          control: '',
          crntoolbox: '',
        },
      },
      methods: {
        nextReaction: function(index) {
          var nextIndex = index + 1;
          if (nextIndex === this.reactions.length) {
            this.reactions.push(blankReaction());            
          }
          
          this.$nextTick(function() {
            document.getElementById('reactant-' + nextIndex).focus();
          });
        },
        removeReaction: function(index) {
          this.reactions.splice(index, 1);
          if (this.reactions.length === 0) {
            this.reactions.push(blankReaction()); 
          }
          
          var prevIndex = Math.max(index - 1, 0);
          this.$nextTick(function() {
            document.getElementById('reactant-' + prevIndex).focus();
          });
        },
        clearReactions: function() {
          this.reactions = [blankReaction()];
        },
        saveReactions: function() {
          saveReactions(this.reactions);
        },
        addIndependentReactions: function() {
          var ctx = this.independentReactionModal;
          for (var i = ctx.startIndex; i <= ctx.endIndex; i++) {
            this.reactions.push({ reactant: '', product: ctx.variable + i, arrow: '->' });
          }
          $('#independent-reactions-modal').foundation('reveal', 'close');
        },
        backToInput: function() {
          this.viewOutput = false;
        },
        generate: function() {
          var reactionNetwork = {
            modelName: this.modelName || "Unnamed Model",
            reactions: this.reactions.map(parseReactionInput),
          };
          flipLeftArrowedReactions(reactionNetwork);
          this.output.ernest = ERNEST_generate(reactionNetwork);
          this.output.control = CONTROL_generate(reactionNetwork);
          this.output.crntoolbox = CRNTOOLBOX_generate(reactionNetwork);
          this.viewOutput = true;
          document.body.click();
        },
      }
    });
    
    var Arrow = {
      left: '<-',
      right: '->',
      both: '<->',
    };
    
    function parseReactionInput(reactionInput) {
      return {
        left: parseComplexInput(reactionInput.reactant),
        right: parseComplexInput(reactionInput.product),
        arrow: reactionInput.arrow,
      };
    }
    
    function parseComplexInput(complexInput) {
      var terms = complexInput.replace(/^\s*(.*?)\s*$/, "$1").split(/\s*\+\s*/);
      return terms.map(function(term) {
        var matchedGroups = term.match(/(\d*)(.*)/);
        return { 
          coefficient: Number(matchedGroups[1]) || 1, 
          variable: matchedGroups[2] || '0'
        };
      });
    }
        
    vm.$watch('reactions', saveReactions);
    vm.$watch('modelName', saveModelName);
    function loadModelName() {
      return localStorage.getItem("CRN-Polyglot-model-name");
    }
    
    function saveModelName(modelName) {
      localStorage.setItem("CRN-Polyglot-model-name", modelName);
    }
    
    function loadReactions() {
      return JSON.parse(localStorage.getItem("CRN-Polyglot-reactions"));
    }
    
    function saveReactions(reactions) {
      localStorage.setItem("CRN-Polyglot-reactions", JSON.stringify(reactions));
    }
    
    window.onunload = function() {
      saveReactions(vm.reactions);
    }
    
    function fillBlanks(text) {
      var count = 0;
      var replacements = arguments;
      var filled = text.replace(/__/g, function() {
        count++;
        return replacements[count];
      });
      return filled;
    }
    
    function getVariables(reactionNetwork) {
      var variableSet = Object.create(null);
      reactionNetwork.reactions.forEach(function(reaction) {
        reaction.left.forEach(function(term) { variableSet[term.variable] = true; });
        reaction.right.forEach(function(term) { variableSet[term.variable] = true; });
      });
      
      delete variableSet['0'];
      var s = Object.keys(variableSet);
      return s;
    }
    
    function flipLeftArrowedReactions(reactionNetwork) {
      var reactions = reactionNetwork.reactions;
      for (var i = 0; i < reactions.length; i++) {
        var reaction = reactions[i];
        if (reaction.arrow === Arrow.left) {
          var newLeft = reaction.right;
          var newRight = reaction.left;
          reaction.left = newLeft;
          reaction.right = newRight;
          reaction.arrow = Arrow.right;
        }
      }
    }
    
    function termToString(term) {
      if (term.coefficient === 1) {
        return term.variable;
      }
      
      return term.coefficient + term.variable;
    }
    
    function complexToStringList(complex) {  // toStringArray?
      return complex.map(termToString);
    }
    
    function isReversible(reaction) {
      return reaction.arrow === Arrow.both;
    }
    
    var saveLink = document.createElement('a');
    saveLink.style.display = 'none';
    document.body.appendChild(saveLink);
    
    var openBrowse = document.createElement('input');
    openBrowse.setAttribute('type', 'file');
    openBrowse.setAttribute('accept', '.crnp');
    openBrowse.style.display = 'none';
    document.body.appendChild(openBrowse);
    
    openBrowse.addEventListener('change', function(event) {
      var file = openBrowse.files[0];
      readCRNP(file);
    });
    
    function readCRNP(file) {
      var reader = new FileReader();
      reader.onload = (function() {
        var j = JSON.parse(reader.result);
        // TODO: error checking...
        vm.modelName = j.name;
        vm.reactions = j.reactions;
      });
      reader.readAsText(file);
    }
    
    function loadCRNP() {
      openBrowse.click();
    }
        
    function saveCRNP() {
      var n = vm.modelName || 'Unnamed Model';
      saveLink.setAttribute('href', 'data:text/text;charset=utf-8,' + JSON.stringify({ name: n, reactions: vm.reactions }));
      saveLink.setAttribute('download', n + '.crnp');
      saveLink.click();
    }
    
    document.body.ondragover = function(e) { e.preventDefault(); return false; }
    document.body.ondrop = function (e) {
      e.preventDefault();
      var file = e.dataTransfer.files[0];
      readCRNP(file);
      return false;
    };
  </script>
  <script src="njs/formats/ernest.js"></script>
  <script src="njs/formats/control.js"></script>
  <script src="njs/formats/crn-toolbox.js"></script>
</body>

</html>